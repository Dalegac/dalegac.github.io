<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="baidu-site-verification" content="code-U1H8DpArhN" /><meta name="google-site-verification" content="QVDlmvOcs2V_mDGnn3PxxIPUmSY8xhIYTsx5BNyLMR0" /><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="pv-proxy-endpoint" content="https://dale-blog-326813.as.r.appspot.com/query?id=ahR6YXN-ZGFsZS1ibG9nLTMyNjgxM3IVCxIIQXBpUXVlcnkYgICAmJSmgwoM"><meta name="generator" content="Jekyll v4.3.4" /><meta property="og:title" content="What is Fiber" /><meta name="author" content="Dale" /><meta property="og:locale" content="en" /><meta name="description" content="1. 设计理念" /><meta property="og:description" content="1. 设计理念" /><link rel="canonical" href="https://dalegac.github.io/posts/what's-is-fiber/" /><meta property="og:url" content="https://dalegac.github.io/posts/what's-is-fiber/" /><meta property="og:site_name" content="Dale" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-09-09T17:21:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="What is Fiber" /><meta name="twitter:site" content="@Dale" /><meta name="twitter:creator" content="@Dale" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Dale"},"dateModified":"2023-06-21T22:25:14+08:00","datePublished":"2021-09-09T17:21:00+08:00","description":"1. 设计理念","headline":"What is Fiber","mainEntityOfPage":{"@type":"WebPage","@id":"https://dalegac.github.io/posts/what's-is-fiber/"},"url":"https://dalegac.github.io/posts/what's-is-fiber/"}</script><title>What is Fiber | Dale</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Dale"><meta name="application-name" content="Dale"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://dale-blog-326813.as.r.appspot.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://dale-blog-326813.as.r.appspot.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang=""><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://github.com/Dalegac/static-pic/blob/master/images/avatar.jpg?raw=true" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Dale</a></div><div class="site-subtitle font-italic">A beginner</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/Dalegac" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/Dale" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['jiacange','gmai.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>What is Fiber</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>What is Fiber</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Dale </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Sep 9, 2021, 5:21 PM +0800" >Sep 9, 2021<i class="unloaded">2021-09-09T17:21:00+08:00</i> </span></div><div> <span> Updated <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Wed, Jun 21, 2023, 10:25 PM +0800" >Jun 21, 2023<i class="unloaded">2023-06-21T22:25:14+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1688 words">9 min read</span> <span id="pv" class="pageviews"> <i class="fas fa-spinner fa-spin fa-fw"></i> </span> views</div></div><div class="post-content"><h2 id="1-设计理念">1. 设计理念</h2><h3 id="11-react-哲学">1.1 React 哲学</h3><blockquote><p>我们认为，React 是用 JavaScript 构建<strong>快速响应</strong>的大型 Web 应用程序的首选方式。他在 Facebook 和 Instagram 上表现优秀。</p></blockquote><h4 id="111-制约快速响应的因素">1.1.1 制约快速响应的因素</h4><ul><li>计算能力——CPU 瓶颈(creating nodes,re-rendering)<li>网络延迟——IO 瓶颈(data fetching,code splitting)</ul><h4 id="112-计算能力限制的解决方案time-slicing">1.1.2 计算能力限制的解决方案————Time Slicing</h4><p>主流浏览器刷新频率为 60Hz，即每（1000ms / 60Hz）16.6ms 浏览器刷新一次。我们知道，JS 可以操作 DOM，GUI 渲染线程与 JS 线程是互斥的。所以 JS 脚本执行和浏览器布局、绘制不能同时执行。在每 16.6ms 时间内，需要完成如下工作：</p><div lang="plaintext" class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>JS脚本执行 ————&gt;  样式布局 ————&gt; 样式绘制
</pre></table></code></div></div><p>当 JS 执行时间过长，超出了 16.6ms，这次刷新就没有时间执行样式布局和样式绘制了。<a href="https://codesandbox.io/s/concurrent-3h48s?file=/src/index.js">demo</a></p><p>React 提出了解决方案：在浏览器每一帧的时间中，预留一些时间给 JS 线程，React 利用这部分时间更新组件(预留的初始时间是 <a href="https://github.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/src/forks/SchedulerHostConfig.default.js#L119">5ms</a>)。</p><p>当预留的时间不够用时，React 将线程控制权交还给浏览器使其有时间渲染 UI，React 则等待下一帧时间到来继续被中断的工作。</p><blockquote><p>这种将长任务分拆到每一帧中，像蚂蚁搬家一样一次执行一小段任务的操作，被称为时间切片</p></blockquote><p>Time Slicing 带来的<strong>好处</strong>：</p><ul><li>React 在渲染（render）的时候，不会阻塞现在的线程<li>如果你的设备足够快，你会感觉渲染是同步的<li>如果你设备非常慢，你会感觉还算是灵敏的<li>虽然是异步渲染，但是你将会看到完整的渲染，而不是一个组件一行行的渲染出来<li>同步书写组件的方式</ul><p>解决 CPU 瓶颈的关键是实现时间切片，而时间切片的关键是：将同步的更新变为可中断的异步更新。</p><p>React 的 Concurrent Mode 启用了时间切片：此时我们的长任务被拆分到每一帧不同的 task 中，JS 脚本执行时间大体在 5ms 左右，这样浏览器就有剩余时间执行样式布局和样式绘制，减少掉帧的可能性。</p><h2 id="2-fiber">2. Fiber</h2><h3 id="21-什么是-fiber">2.1 什么是 Fiber？</h3><blockquote><p>This Fiber is just a plain JavaScript object and it has one to one relationship with an instance. It manages the work for an instance so it keeps track of which instance is for using the property state node. It also keeps track of its relationships to other fibers in the tree. <a href="https://www.youtube.com/watch?v=ZCuYPiUIONs">Lin Clark - A Cartoon Intro to Fiber - React Conf 2017</a></p></blockquote><p><strong>Fiber 的含义</strong>：作为静态的数据结构来说，每个 Fiber 节点对应一个 React element，保存了该组件的类型（函数组件/类组件/原生组件…）、对应的 DOM 节点等信息。 作为动态的工作单元来说，每个 Fiber 节点保存了本次更新中该组件改变的状态、要执行的工作（需要被删除/被插入页面中/被更新…）</p><h3 id="22-fiber-的数据结构">2.2 Fiber 的数据结构</h3><p>源文件<a href="https://github1s.com/facebook/react/blob/HEAD/packages/react-reconciler/src/ReactFiber.new.js">ReactFiber.new.js</a></p><div lang="js" class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre>
<span class="kd">function</span> <span class="nf">FiberNode</span><span class="p">(</span>
  <span class="nx">tag</span><span class="p">:</span> <span class="nx">WorkTag</span><span class="p">,</span>
  <span class="nx">pendingProps</span><span class="p">:</span> <span class="nx">mixed</span><span class="p">,</span>
  <span class="nx">key</span><span class="p">:</span> <span class="kc">null</span> <span class="o">|</span> <span class="nx">string</span><span class="p">,</span>
  <span class="nx">mode</span><span class="p">:</span> <span class="nx">TypeOfMode</span><span class="p">,</span>
<span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Instance</span>
  <span class="c1">// 作为静态数据结构的属性</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">tag</span> <span class="o">=</span> <span class="nx">tag</span><span class="p">;</span> <span class="c1">// 对应的组件类型FunctionComponent,ClassComponent,HooksComponent(DOM结点对应的Fiber结点)</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">key</span> <span class="o">=</span> <span class="nx">key</span><span class="p">;</span> <span class="c1">// 我们常用的元素key</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">elementType</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// 大部分情况下elementType与type相同，在某些情况下，比如FunctionComponent使用React.Memo包裹时，两者不同</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">type</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// 对于FunctionComponent是函数本身，对于ClassComponent是class，对于HooksComponent是DOM结点的TagName</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">stateNode</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span> <span class="c1">// 对于HooksComponent是是它真实对应的DOM结点</span>

  <span class="c1">// Fiber</span>
  <span class="c1">// 用于连接其他Fiber节点形成Fiber树</span>
  <span class="k">this</span><span class="p">.</span><span class="k">return</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">child</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">sibling</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="c1">// 对于多个同级Fiber节点，代表他们插入DOM的位置索引</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="c1">// 就是我们常用的ref属性</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">ref</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="c1">// 从这里往下，都是作为动态的工作单元的属性</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">pendingProps</span> <span class="o">=</span> <span class="nx">pendingProps</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">memoizedProps</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">updateQueue</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">memoizedState</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">dependencies</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="nx">mode</span><span class="p">;</span>

  <span class="c1">// Effects</span>
  <span class="c1">// 名称中带有Effect代表副作用相关，对于HostComponent副作用包括DOM节点的增删查改，</span>
  <span class="c1">// 对于FunctionComponent副作用代表了我们使用useEffect或者useLayoutEffect这两个hook</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">effectTag</span> <span class="o">=</span> <span class="nx">NoEffect</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">nextEffect</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">firstEffect</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">lastEffect</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>

  <span class="c1">// 调度优先级相关</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">lanes</span> <span class="o">=</span> <span class="nx">NoLanes</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">childLanes</span> <span class="o">=</span> <span class="nx">NoLanes</span><span class="p">;</span>

  <span class="c1">// 指向该fiber在另一次更新时对应的fiber</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">alternate</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
  <span class="p">......</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="23-调度器的优先级">2.3 调度器的优先级</h3><p>源文件<a href="https://github1s.com/facebook/react/blob/1fb18e22ae66fdb1dc127347e169e73948778e5a/packages/scheduler/src/SchedulerPriorities.js">SchedulerPriorities.js</a></p><div lang="js" class="language-js highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="cm">/**
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 *
 * @flow
 */</span>

<span class="k">export</span> <span class="nx">type</span> <span class="nx">PriorityLevel</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">|</span> <span class="mi">2</span> <span class="o">|</span> <span class="mi">3</span> <span class="o">|</span> <span class="mi">4</span> <span class="o">|</span> <span class="mi">5</span><span class="p">;</span>

<span class="c1">// TODO: Use symbols?</span>
<span class="c1">// 初始化时的无优先级</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">NoPriority</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="c1">// 立刻执行的优先级，也就是同步的优先级，react中最高优的优先级</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">ImmediatePriority</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="c1">// 由用户触发的更新，比如在点击事件回调onClick触发了this.setState,</span>
<span class="c1">//那么这个this.setState创建的Update就是此优先级</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">UserBlockingPriority</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

<span class="c1">// 比如在应用中请求服务的数据，数据返回时更新状态，这里的更新就是此优先级</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">NormalPriority</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="c1">// Suspense就是</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">LowPriority</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

<span class="c1">// 空闲的优先级</span>
<span class="k">export</span> <span class="kd">const</span> <span class="nx">IdlePriority</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
</pre></table></code></div></div><h2 id="3-fiber-架构的工作原理">3. Fiber 架构的工作原理</h2><h3 id="31-工作阶段">3.1 工作阶段</h3><p>Lin Clark 举了一个例子 React 的工作流程分为两个阶段：</p><ul><li>render 阶段(可中断的)<li>commit 阶段(不可中断) <img data-proofer-ignore data-src="https://github.com/Dalegac/static-pic/blob/master/images/Fiber%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B.jpg?raw=true" alt="Fiber工作流程" /></ul><p>render 阶段，从 workInProgress Tree 的根出发，深度优先遍历树，组件会经过 beginWork 和 completeWork 阶段，最后 react 将 workInProgress Tree 作为 pendingCommit，第一阶段到此结束。至此我们更新了 workInProgress Tree，并且得出了树中需要更新的结点列表 effectList。 <img data-proofer-ignore data-src="https://github.com/Dalegac/static-pic/blob/master/images/effectList.jpg?raw=true" alt="effectList" /> <img data-proofer-ignore data-src="https://github.com/Dalegac/static-pic/blob/master/images/pendingcommit.jpg?raw=true" alt="workInProgress Tree" /></p><p>commit 阶段，react 会依次遍历 effectList，将这次的更新 commit 给 DOM。</p><p><img data-proofer-ignore data-src="https://github.com/Dalegac/static-pic/blob/master/images/%E9%81%8D%E5%8E%86effectlist.jpg?raw=true" alt="遍历effectList" /></p><h3 id="32-double-buffering">3.2 Double Buffering</h3><p>在构建 workInProgress Fiber 树时会尝试复用 current Fiber 树中已有的 Fiber 节点内的属性。类似于 canavas 的双缓存，这样能节省内存分配和垃圾回收的时间。 <img data-proofer-ignore data-src="https://github.com/Dalegac/static-pic/blob/master/images/doublebuffering.png?raw=true" alt="双缓存机制" /></p><h2 id="4-参考">4. 参考</h2><ul><li><p><a href="https://www.youtube.com/watch?v=v6iR3Zk4oDY&amp;list=PL3j9y0zHLR-nWZ66DsnexvS0TNhtiqElY&amp;index=1&amp;t=58s">Beyond React 16 by Dan Abramov - JSConf Iceland</a></p><li><p><a href="https://www.youtube.com/watch?v=ZCuYPiUIONs&amp;list=PL3j9y0zHLR-nWZ66DsnexvS0TNhtiqElY&amp;index=2&amp;t=576s">Lin Clark - A Cartoon Intro to Fiber - React Conf 2017</a></p></ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blogging/'>Blogging</a>, <a href='/categories/react/'>React</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/react/" class="post-tag no-text-decoration" >react</a> <a href="/tags/fiber/" class="post-tag no-text-decoration" >fiber</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=What is Fiber - Dale&url=https://dalegac.github.io/posts/what's-is-fiber/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=What is Fiber - Dale&u=https://dalegac.github.io/posts/what's-is-fiber/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=What is Fiber - Dale&url=https://dalegac.github.io/posts/what's-is-fiber/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink('', 'Link copied successfully!')" data-toggle="tooltip" data-placement="top" title="Copy link"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/enterprise-level-large-file-upload/">企业级大文件上传</a><li><a href="/posts/what's-is-fiber/">What is Fiber</a><li><a href="/posts/javasript-array-methods/">JavaScript数组方法</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/javascript/">JavaScript</a> <a class="post-tag" href="/tags/vue/">Vue</a> <a class="post-tag" href="/tags/array/">Array</a> <a class="post-tag" href="/tags/fiber/">fiber</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/nodejs/">Nodejs</a> <a class="post-tag" href="/tags/nvm/">nvm</a> <a class="post-tag" href="/tags/react/">react</a> <a class="post-tag" href="/tags/vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/">Vuejs设计与实现</a> <a class="post-tag" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/publish-subscribe-pattern/"><div class="card-body"> <span class="timeago small" >Sep 15, 2021<i class="unloaded">2021-09-15T22:45:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>发布-订阅模式</h3><div class="text-muted small"><p> 发布—订阅模式可以广泛应用于异步编程中，这是一种替代传递回调函数的方案。 比如，我们可以订阅 ajax 请求的 error、success 等事件。或者如果想在动画的每一帧完成之后做一些事情，那我们可以订阅一个事件，然后在动画的每一帧完成之后发布这个事件。在异步编程中使用发布—订阅模式，我们就无需过多关注对象在异步运行期间的内部状态，而只需要订阅感兴趣的事件发生点。 发布—订阅模式可以取代...</p></div></div></a></div><div class="card"> <a href="/posts/javasript-array-methods/"><div class="card-body"> <span class="timeago small" >Sep 26, 2021<i class="unloaded">2021-09-26T11:16:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JavaScript数组方法</h3><div class="text-muted small"><p> 1. 数组的声明 1.1 数组文本 使用数组文本是创建 JavaScript 数组最简单的方法。 1 var array-name = [item1, item2, ...]; 空格和折行并不重要，声明可横跨多行。 请不要最后一个元素之后写逗号，比如： 1 var guns = ["AWM","98Kar","Uzi",] 可能存在跨浏览器兼容性问题。 1.2 使用 Jav...</p></div></div></a></div><div class="card"> <a href="/posts/deepClone/"><div class="card-body"> <span class="timeago small" >Oct 5, 2021<i class="unloaded">2021-10-05T09:52:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>深拷贝</h3><div class="text-muted small"><p> 1. 需要考虑的问题 基本实现 递归能力 循环引用 考虑问题的全面性 理解 weakmap 的真正意义 多种类型 考虑问题的严谨性 创建各种引用类型的方法，JS API 的熟练程度 准确的判断数据类型，对数据类型的理解程度 ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <a href="/posts/publish-subscribe-pattern/" class="btn btn-outline-primary" prompt="Newer"><p>发布-订阅模式</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/Dale24745082">Dale</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/javascript/">JavaScript</a> <a class="post-tag" href="/tags/vue/">Vue</a> <a class="post-tag" href="/tags/array/">Array</a> <a class="post-tag" href="/tags/fiber/">fiber</a> <a class="post-tag" href="/tags/linux/">Linux</a> <a class="post-tag" href="/tags/nodejs/">Nodejs</a> <a class="post-tag" href="/tags/nvm/">nvm</a> <a class="post-tag" href="/tags/react/">react</a> <a class="post-tag" href="/tags/vuejs%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%AE%9E%E7%8E%B0/">Vuejs设计与实现</a> <a class="post-tag" href="/tags/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">文件上传</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://dalegac.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script async src="https://cdn.jsdelivr.net/npm/countup.js@1.9.3/dist/countUp.min.js"></script> <script defer src="/assets/js/dist/pvreport.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"> </script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-B0741WGFCY"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-B0741WGFCY'); }); </script>
